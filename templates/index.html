{% extends "base.html" %}

{% block title %}首页 - ResNet包装分类系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="text-center text-white mb-4">
            <h1 class="display-4 fw-bold">
                <i class="fas fa-brain me-3"></i>
                ResNet包装分类系统
            </h1>
            <p class="lead">基于深度学习的包装质量检测系统</p>
        </div>
    </div>
</div>

<!-- 系统状态卡片 -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                <h5 class="card-title">模型状态</h5>
                {% if model_loaded %}
                    <span class="status-indicator status-online"></span>
                    <span class="text-success fw-bold">已加载</span>
                {% else %}
                    <span class="status-indicator status-offline"></span>
                    <span class="text-danger fw-bold">未加载</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-database fa-3x text-info mb-3"></i>
                <h5 class="card-title">数据集</h5>
                {% if stats %}
                    <p class="mb-1"><strong>{{ stats.total_samples }}</strong> 个样本</p>
                    <small class="text-muted">{{ stats.ok_count }} 合格 / {{ stats.ng_count }} 不合格</small>
                {% else %}
                    <span class="text-warning">数据未加载</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
                <h5 class="card-title">准确率</h5>
                {% if stats and stats.total_samples > 0 %}
                    <p class="mb-1"><strong>{{ "%.1f"|format(stats.ok_count / stats.total_samples * 100) }}%</strong></p>
                    <small class="text-muted">合格率</small>
                {% else %}
                    <span class="text-muted">暂无数据</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 图像上传和预测区域 -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    图像质量检测
                </h4>
            </div>
            <div class="card-body">
                {% if not model_loaded %}
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    模型将在首次上传时自动加载。如需手动管理模型，请访问<a href="{{ url_for('model_info') }}" class="alert-link">模型信息</a>页面。
                </div>
                {% endif %}
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                    <h5>拖拽图片到此处或点击选择文件</h5>
                    <p class="text-muted mb-3">支持 PNG, JPG, JPEG, BMP 格式，最大 16MB</p>
                    <input type="file" id="fileInput" name="file" accept=".png,.jpg,.jpeg,.bmp" style="display: none;">
                    <button type="button" class="btn btn-primary" id="selectFileBtn">
                        <i class="fas fa-folder-open me-2"></i>选择文件
                    </button>
                </div>
                
                <!-- 上传进度 -->
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center mt-2 mb-0">正在处理图像...</p>
                </div>
                
                <!-- 预测结果 -->
                <div id="resultArea" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 最近预测历史 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    使用说明
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle text-info me-2"></i>如何使用</h6>
                        <ol>
                            <li>选择或拖拽包装图片到上传区域</li>
                            <li>系统将自动分析图片质量</li>
                            <li>查看预测结果和置信度</li>
                            <li>如果模型未加载，系统会自动尝试加载</li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-lightbulb text-warning me-2"></i>注意事项</h6>
                        <ul>
                            <li>图片格式：PNG, JPG, JPEG, BMP</li>
                            <li>文件大小：最大 16MB</li>
                            <li>建议图片清晰度较高</li>
                            <li>确保包装物体在图片中心</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Document ready, jQuery version:', $.fn.jquery);
    
    const uploadArea = $('#uploadArea');
    const fileInput = $('#fileInput');
    const selectFileBtn = $('#selectFileBtn');
    const uploadForm = $('#uploadForm');
    const uploadProgress = $('#uploadProgress');
    const resultArea = $('#resultArea');
    
    console.log('Elements found:');
    console.log('uploadArea:', uploadArea.length);
    console.log('fileInput:', fileInput.length);
    console.log('selectFileBtn:', selectFileBtn.length);
    
    // 点击选择文件按钮
    selectFileBtn.click(function() {
        console.log('Select file button clicked');
        fileInput[0].click();
    });
    
    // 点击上传区域选择文件
    uploadArea.click(function(e) {
        // 如果点击的是按钮，不处理
        if (e.target.id === 'selectFileBtn' || $(e.target).closest('#selectFileBtn').length > 0) {
            return;
        }
        console.log('Upload area clicked');
        fileInput[0].click();
    });
    
    // 拖拽功能
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        
        // 文件拖拽处理
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            fileInput[0].files = files;
            handleFileUpload();
        }
    });
    
    // 文件选择变化
    fileInput.change(function() {
        if (this.files.length > 0) {
            handleFileUpload();
        }
    });
    
    function handleFileUpload() {
        const file = fileInput[0].files[0];
        if (!file) return;
        
        // 验证文件类型
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/bmp'];
        if (!allowedTypes.includes(file.type)) {
            showAlert('请选择有效的图片格式 (PNG, JPG, JPEG, BMP)', 'danger');
            return;
        }
        
        // 验证文件大小 (16MB)
        if (file.size > 16 * 1024 * 1024) {
            showAlert('文件大小不能超过 16MB', 'danger');
            return;
        }
        
        // 显示进度条
        uploadProgress.show();
        resultArea.hide();
        
        // 创建FormData
        const formData = new FormData();
        formData.append('file', file);
        
        // 上传文件
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(evt) {
                    if (evt.lengthComputable) {
                        const percentComplete = evt.loaded / evt.total * 100;
                        $('.progress-bar').css('width', percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                uploadProgress.hide();
                if (response.success) {
                    showResult(response.result, response.filename);
                } else {
                    showAlert(response.error || '上传失败', 'danger');
                }
            },
            error: function(xhr) {
                uploadProgress.hide();
                const response = xhr.responseJSON;
                showAlert(response?.error || '上传失败，请重试', 'danger');
            }
        });
    }
    
    function showResult(result, filename) {
        const isOK = result.predicted_class === 0;  // 修正：索引0对应OK，索引1对应NG
        const cardClass = isOK ? 'border-success' : 'border-danger';
        const badgeClass = isOK ? 'bg-success' : 'bg-danger';
        const iconClass = isOK ? 'fa-check-circle' : 'fa-times-circle';
        const confidenceColor = isOK ? 'bg-success' : 'bg-danger';
        
        const resultHtml = `
            <div class="card result-card ${cardClass}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas ${iconClass} me-2"></i>
                        预测结果
                    </h5>
                    <span class="badge ${badgeClass} fs-6">${result.predicted_label}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <img src="/uploads/${filename}" class="img-fluid rounded" alt="上传的图片" style="max-height: 300px;">
                        </div>
                        <div class="col-md-6">
                            <h6>预测详情</h6>
                            <div class="mb-3">
                                <label class="form-label">置信度</label>
                                <div class="confidence-bar ${confidenceColor}">
                                    <div class="confidence-text">${(result.confidence * 100).toFixed(1)}%</div>
                                </div>
                            </div>
                            
                            <h6>类别概率</h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>OK (合格)</span>
                                    <span>${(result.probabilities.OK * 100).toFixed(1)}%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: ${result.probabilities.OK * 100}%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>NG (不合格)</span>
                                    <span>${(result.probabilities.NG * 100).toFixed(1)}%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-danger" style="width: ${result.probabilities.NG * 100}%"></div>
                                </div>
                            </div>
                            
                            <div class="alert ${isOK ? 'alert-success' : 'alert-danger'} mt-3">
                                <i class="fas ${isOK ? 'fa-thumbs-up' : 'fa-thumbs-down'} me-2"></i>
                                ${isOK ? '包装质量合格，可以通过检测。' : '包装质量不合格，需要进一步检查。'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        resultArea.html(resultHtml).show();
    }
    
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        resultArea.html(alertHtml).show();
        
        // 3秒后自动隐藏
        setTimeout(function() {
            $('.alert').alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}